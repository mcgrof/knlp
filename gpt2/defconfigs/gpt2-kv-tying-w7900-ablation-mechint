# GPT-2 KV Tying Mechanistic Interpretability Analysis on AMD Radeon Pro W7900
# Post-training analysis of models from gpt2-kv-tying-w7900-ablation
# Discovers sparse KV circuits via binary channel masking
# Optimized for AMD Radeon Pro W7900 (48GB VRAM)
CONFIG_MODEL_MODE_SINGLE=y
CONFIG_MODEL_SELECT_GPT2=y
CONFIG_MODEL_GPT2=y
CONFIG_MODEL="gpt2"

# GPT-2 Configuration (must match training configuration)
CONFIG_GPT2_MODEL_124M=y
CONFIG_GPT2_MODEL_NAME="gpt2"

# Dataset - Shakespeare (must match training dataset)
CONFIG_GPT2_DATASET_SHAKESPEARE=y
CONFIG_GPT2_DATASET_NAME="shakespeare"

# Model Architecture (must match training)
CONFIG_GPT2_BLOCK_SIZE=1024
CONFIG_GPT2_DROPOUT="0.1"
CONFIG_GPT2_BIAS=y
CONFIG_GPT2_WEIGHT_TYING=y

# Performance Optimizations - W7900 / ROCm optimized
CONFIG_GPT2_FLASH_ATTENTION=n
CONFIG_GPT2_COMPILE=n
CONFIG_GPT2_CUDNN_BENCHMARK=y
CONFIG_GPT2_TF32_ALLOWED=y
CONFIG_GPT2_AMP_DTYPE="bfloat16"

# Batch size - smaller for analysis (memory efficiency)
CONFIG_BATCH_SIZE=8
CONFIG_NUM_WORKERS=8
CONFIG_DEVICE="cuda"
CONFIG_DATA_DIR="./gpt2/data"
CONFIG_PIN_MEMORY=y
CONFIG_PERSISTENT_WORKERS=y
CONFIG_PREFETCH_FACTOR=2

# Optimizer - Not used for analysis but required by config
CONFIG_OPTIMIZER_MODE_SINGLE=y
CONFIG_OPTIMIZER_SELECT_ADAMW=y
CONFIG_OPTIMIZER="adamw"

# Pruning - Disabled
CONFIG_PRUNING_MODE_NONE=y
CONFIG_PRUNING_METHOD="none"

# Mechanistic Interpretability - ENABLED
CONFIG_KNLP_MECHINT=y

# Run post-training KV feature-circuit analysis
# Override with MODELS= to use visualization-only mode
CONFIG_KNLP_MECHINT_KV_POSTTRAIN=y

# Checkpoint pattern to analyze (glob pattern for ablation runs)
# Analyzes all ablation steps: stepV0, stepV1, etc.
# Override with MODELS=foo to analyze checkpoints from foo/ directory
CONFIG_KNLP_MECHINT_KV_CHECKPOINT="./output/final_model_step*.pt"

# KV Circuit Analysis Parameters
# Target: prune 95% of K/V channels while maintaining performance
CONFIG_KNLP_MECHINT_KV_TARGET_SPARSITY="0.95"

# Optimization steps for mask learning
CONFIG_KNLP_MECHINT_KV_STEPS=500

# Learning rate for mask optimization
CONFIG_KNLP_MECHINT_KV_LR="0.01"

# Target metric to preserve during pruning
CONFIG_KNLP_MECHINT_KV_TARGET_METRIC="loss"

# Temperature annealing: smooth binary mask convergence
CONFIG_KNLP_MECHINT_KV_TEMP_SCHEDULE="linear:1.0:0.1"

# Sparsity schedule: gradual increase (cubic recommended)
CONFIG_KNLP_MECHINT_KV_SPARSITY_SCHEDULE="cubic"

# L1 regularization on mask logits
CONFIG_KNLP_MECHINT_KV_L1_LAMBDA="0.001"

# Use hard binary masks for discrete circuit discovery
CONFIG_KNLP_MECHINT_KV_HARD_MASKS=y

# Output directory for analysis results
CONFIG_KNLP_MECHINT_OUTPUT_DIR="mechint_analysis_kv_w7900"

# Visualization Options
CONFIG_KNLP_MECHINT_VISUALIZE_HEATMAPS=y
CONFIG_KNLP_MECHINT_VISUALIZE_CURVES=y
CONFIG_KNLP_MECHINT_VISUALIZE_FAITHFULNESS=y
CONFIG_KNLP_MECHINT_VISUALIZE_WANDB=y
CONFIG_KNLP_MECHINT_SAVE_MASKS=y

# W&B Integration
CONFIG_ENABLE_TRACKIO=n
CONFIG_ENABLE_WANDB=y
CONFIG_WANDB_PROJECT="gpt2-mechint-kv-w7900"
CONFIG_WANDB_ENTITY=""
CONFIG_TRACKER_PROJECT="gpt2-mechint-kv-w7900"

# Advanced options
CONFIG_COMPILE_MODEL=n
CONFIG_MIXED_PRECISION=y
CONFIG_GPU_WARMUP=y

# Checkpointing - Not used for analysis
CONFIG_SAVE_CHECKPOINT=n

# Memory Optimizations - ROCm specific
CONFIG_PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"
CONFIG_TORCH_ROCM_AOTRITON_ENABLE_EXPERIMENTAL=n

# Debugging
CONFIG_DEBUG=n
CONFIG_VERBOSE=y
CONFIG_LOG_LEVEL="INFO"
CONFIG_DRY_RUN=n
