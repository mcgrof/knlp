<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KVSplice: FIM-Guided KV Cache Compression</title>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@16.14.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@16.14.0/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@1.8.5/umd/Recharts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0f172a; }
    .gradient-text {
      background: linear-gradient(135deg, #f97316, #ea580c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .card {
      background: linear-gradient(145deg, #1e293b, #1a2332);
      border: 1px solid #334155;
    }
  </style>
</head>
<body class="min-h-screen text-gray-100">
  <!-- Shared Navigation -->
  <nav class="bg-gray-900 border-b border-gray-800 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-wrap justify-center gap-2">
      <a href="index.html" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-sm font-medium text-gray-300 transition-colors">← Home</a>
      <a href="fisher_adam_visualization.html" class="px-3 py-1.5 bg-gray-800 hover:bg-blue-600 rounded text-sm font-medium text-gray-300 hover:text-white transition-colors">FIM-Adam</a>
      <a href="fim_quantization_visualization.html" class="px-3 py-1.5 bg-gray-800 hover:bg-purple-600 rounded text-sm font-medium text-gray-300 hover:text-white transition-colors">Quantization</a>
      <a href="kvsplice_visualization.html" class="px-3 py-1.5 bg-orange-600 rounded text-sm font-medium text-white">KVSplice</a>
      <a href="ra_visualization.html" class="px-3 py-1.5 bg-gray-800 hover:bg-cyan-600 rounded text-sm font-medium text-gray-300 hover:text-white transition-colors">RA</a>
      <a href="tiering_visualization.html" class="px-3 py-1.5 bg-gray-800 hover:bg-emerald-600 rounded text-sm font-medium text-gray-300 hover:text-white transition-colors">Tiering</a>
      <a href="gnn_fraud_visualization.html" class="px-3 py-1.5 bg-gray-800 hover:bg-rose-600 rounded text-sm font-medium text-gray-300 hover:text-white transition-colors">GNN Fraud</a>
    </div>
  </nav>

  <div id="root"></div>

  <script type="text/babel">
    const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine, Cell, ComposedChart, Area } = Recharts;

    // Real W&B data from gpt2-kvsplice-ablation-test
    const WANDB_DATA = {
      baseline: {
        name: "MLA (6x compression)",
        global_trace: 0.818,
        val_perplexity: 71.05,
        hellaswag: 0.30,
        per_layer: {
          0: { avg: 0.947, heads: [0.928, 0.949, 0.931, 0.935, 0.958, 0.950, 0.942, 0.946, 0.964, 0.968, 0.940, 0.956] },
          6: { avg: 0.689, heads: [0.569, 0.816, 0.921, 0.371, 0.742, 0.760, 0.812, 0.949, 0.365, 0.653, 0.696, 0.621] },
          11: { avg: 0.819, heads: [0.703, 0.769, 0.825, 0.754, 0.800, 0.898, 0.734, 0.854, 0.739, 0.929, 0.915, 0.903] }
        }
      },
      fim_guided: {
        name: "KVSplice + FIM (7.2x compression)",
        global_trace: 0.911,
        val_perplexity: 63.08,
        hellaswag: 0.31,
        per_layer: {
          0: { avg: 0.946, heads: [0.945, 0.954, 0.941, 0.923, 0.956, 0.949, 0.962, 0.944, 0.941, 0.945, 0.966, 0.932] },
          6: { avg: 0.845, heads: [0.768, 0.890, 0.920, 0.812, 0.862, 0.917, 0.860, 0.819, 0.896, 0.905, 0.746, 0.550] },
          11: { avg: 0.958, heads: [0.977, 0.970, 0.949, 0.959, 0.941, 0.936, 0.969, 0.959, 0.960, 0.955, 0.966, 0.962] }
        }
      }
    };

    // Section 0: Key Discovery - FIM Trace and Compression
    function KeyDiscoverySection() {
      const compressionData = [
        { name: 'Standard\nGPT-2', compression: 1, trace: 0.75, ppl: 100, color: '#6b7280' },
        { name: 'MLA\n(6x)', compression: 6, trace: 0.818, ppl: 71, color: '#3b82f6' },
        { name: 'KVSplice\n(7.2x)', compression: 7.2, trace: 0.911, ppl: 63, color: '#f97316' },
      ];

      return (
        <div className="card rounded-xl p-6 mb-8">
          <h2 className="text-2xl font-bold mb-2 text-orange-400">The Key Insight: FIM Trace Guides Compression</h2>
          <p className="text-gray-400 mb-4">
            Higher compression → remaining parameters must carry more representational work → higher FIM trace.
            FIM trace identifies which layers are critical and should be protected during compression.
          </p>

          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <h3 className="text-lg font-semibold mb-3 text-gray-300">Compression vs FIM Trace</h3>
              <ResponsiveContainer width="100%" height={250}>
                <ComposedChart data={compressionData}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                  <XAxis dataKey="name" stroke="#9ca3af" tick={{ fill: '#9ca3af', fontSize: 11 }} />
                  <YAxis yAxisId="left" stroke="#9ca3af" domain={[0, 10]} label={{ value: 'Compression Ratio', angle: -90, position: 'insideLeft', fill: '#9ca3af' }} />
                  <YAxis yAxisId="right" orientation="right" stroke="#9ca3af" domain={[0.7, 1]} label={{ value: 'FIM Trace', angle: 90, position: 'insideRight', fill: '#9ca3af' }} />
                  <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155' }} />
                  <Bar yAxisId="left" dataKey="compression" name="Compression" fill="#3b82f6" opacity={0.7}>
                    {compressionData.map((entry, index) => (
                      <Cell key={index} fill={entry.color} />
                    ))}
                  </Bar>
                  <Line yAxisId="right" type="monotone" dataKey="trace" name="FIM Trace" stroke="#f97316" strokeWidth={3} dot={{ fill: '#f97316', r: 6 }} />
                </ComposedChart>
              </ResponsiveContainer>
            </div>

            <div>
              <h3 className="text-lg font-semibold mb-3 text-gray-300">Why FIM Trace Matters</h3>
              <div className="bg-gray-900 rounded-lg p-4 text-sm font-mono mb-4">
                <div className="text-gray-400 mb-2">FIM Trace = Σ eigenvalues = Total curvature</div>
                <div className="text-orange-400">High trace → Critical layer</div>
                <div className="text-blue-400">Low trace → Safe to compress</div>
              </div>
              <div className="space-y-2 text-sm">
                <div className="flex items-center gap-2">
                  <span className="w-3 h-3 rounded-full bg-gray-500"></span>
                  <span className="text-gray-400">Standard: No compression, baseline trace</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="w-3 h-3 rounded-full bg-blue-500"></span>
                  <span className="text-gray-400">MLA: 6x compression, trace rises to 0.818</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="w-3 h-3 rounded-full bg-orange-500"></span>
                  <span className="text-gray-400">KVSplice: 7.2x compression, trace rises to 0.911</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Section 1: Per-Layer FIM Trace Comparison
    function LayerTraceSection() {
      const layerData = [
        {
          layer: 'Layer 0\n(Early)',
          baseline: WANDB_DATA.baseline.per_layer[0].avg,
          fim_guided: WANDB_DATA.fim_guided.per_layer[0].avg,
          insight: 'Both high - early layers critical'
        },
        {
          layer: 'Layer 6\n(Middle)',
          baseline: WANDB_DATA.baseline.per_layer[6].avg,
          fim_guided: WANDB_DATA.fim_guided.per_layer[6].avg,
          insight: 'FIM identifies compression opportunity'
        },
        {
          layer: 'Layer 11\n(Late)',
          baseline: WANDB_DATA.baseline.per_layer[11].avg,
          fim_guided: WANDB_DATA.fim_guided.per_layer[11].avg,
          insight: 'FIM-guided protects critical late layer'
        }
      ];

      return (
        <div className="card rounded-xl p-6 mb-8">
          <h2 className="text-2xl font-bold mb-2 text-orange-400">Section 1: Per-Layer FIM Trace</h2>
          <p className="text-gray-400 mb-4">
            FIM trace varies across layers. KVSplice uses this signal to apply surgical compression:
            compress where trace is low, protect where trace is high.
          </p>

          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <h3 className="text-lg font-semibold mb-3 text-gray-300">Layer-wise Average Trace</h3>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={layerData} layout="vertical">
                  <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                  <XAxis type="number" stroke="#9ca3af" domain={[0, 1]} />
                  <YAxis type="category" dataKey="layer" stroke="#9ca3af" width={80} tick={{ fill: '#9ca3af', fontSize: 11 }} />
                  <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155' }} />
                  <Legend />
                  <Bar dataKey="baseline" name="MLA Baseline" fill="#3b82f6" />
                  <Bar dataKey="fim_guided" name="KVSplice + FIM" fill="#f97316" />
                </BarChart>
              </ResponsiveContainer>
            </div>

            <div>
              <h3 className="text-lg font-semibold mb-3 text-gray-300">Interpretation</h3>
              <div className="space-y-4">
                {layerData.map((layer, idx) => (
                  <div key={idx} className="bg-gray-900 rounded-lg p-3">
                    <div className="flex justify-between items-center mb-2">
                      <span className="font-semibold text-gray-200">{layer.layer.replace('\n', ' ')}</span>
                      <span className={`text-xs px-2 py-1 rounded ${layer.fim_guided > layer.baseline ? 'bg-orange-900 text-orange-300' : 'bg-blue-900 text-blue-300'}`}>
                        {layer.fim_guided > layer.baseline ? '↑ Protected' : '↓ Compressed'}
                      </span>
                    </div>
                    <div className="text-sm text-gray-400">{layer.insight}</div>
                    <div className="text-xs text-gray-500 mt-1">
                      Δ = {((layer.fim_guided - layer.baseline) * 100).toFixed(1)}% trace change
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Section 2: Per-Head Heatmap Comparison
    function HeadHeatmapSection() {
      const [selectedLayer, setSelectedLayer] = React.useState(6);

      const getHeadData = (layer) => {
        const baselineHeads = WANDB_DATA.baseline.per_layer[layer].heads;
        const fimHeads = WANDB_DATA.fim_guided.per_layer[layer].heads;
        return baselineHeads.map((val, idx) => ({
          head: `H${idx}`,
          baseline: val,
          fim_guided: fimHeads[idx],
          delta: fimHeads[idx] - val
        }));
      };

      const headData = getHeadData(selectedLayer);

      // Color scale for heatmap
      const getColor = (val) => {
        if (val > 0.95) return '#dc2626'; // red - critical
        if (val > 0.85) return '#f97316'; // orange - important
        if (val > 0.70) return '#eab308'; // yellow - moderate
        return '#22c55e'; // green - compressible
      };

      return (
        <div className="card rounded-xl p-6 mb-8">
          <h2 className="text-2xl font-bold mb-2 text-orange-400">Section 2: Per-Head FIM Trace Heatmap</h2>
          <p className="text-gray-400 mb-4">
            Each attention head has different importance. FIM trace reveals which heads are critical
            (red/orange) vs compressible (green). Click layers to explore.
          </p>

          <div className="flex gap-4 mb-4">
            {[0, 6, 11].map(layer => (
              <button
                key={layer}
                onClick={() => setSelectedLayer(layer)}
                className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                  selectedLayer === layer
                    ? 'bg-orange-600 text-white'
                    : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
                }`}
              >
                Layer {layer}
              </button>
            ))}
          </div>

          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <h3 className="text-lg font-semibold mb-3 text-gray-300">MLA Baseline (Layer {selectedLayer})</h3>
              <div className="grid grid-cols-6 gap-1">
                {headData.map((h, idx) => (
                  <div
                    key={idx}
                    className="aspect-square rounded flex items-center justify-center text-xs font-mono text-white"
                    style={{ backgroundColor: getColor(h.baseline) }}
                    title={`Head ${idx}: ${h.baseline.toFixed(3)}`}
                  >
                    {h.baseline.toFixed(2)}
                  </div>
                ))}
              </div>
              <div className="text-xs text-gray-500 mt-2">
                Avg: {WANDB_DATA.baseline.per_layer[selectedLayer].avg.toFixed(3)}
              </div>
            </div>

            <div>
              <h3 className="text-lg font-semibold mb-3 text-gray-300">KVSplice + FIM (Layer {selectedLayer})</h3>
              <div className="grid grid-cols-6 gap-1">
                {headData.map((h, idx) => (
                  <div
                    key={idx}
                    className="aspect-square rounded flex items-center justify-center text-xs font-mono text-white"
                    style={{ backgroundColor: getColor(h.fim_guided) }}
                    title={`Head ${idx}: ${h.fim_guided.toFixed(3)}`}
                  >
                    {h.fim_guided.toFixed(2)}
                  </div>
                ))}
              </div>
              <div className="text-xs text-gray-500 mt-2">
                Avg: {WANDB_DATA.fim_guided.per_layer[selectedLayer].avg.toFixed(3)}
              </div>
            </div>
          </div>

          <div className="mt-4 flex items-center gap-4 text-xs">
            <span className="text-gray-400">Trace scale:</span>
            <div className="flex items-center gap-1">
              <div className="w-4 h-4 rounded bg-green-500"></div>
              <span className="text-gray-400">&lt;0.70 (compressible)</span>
            </div>
            <div className="flex items-center gap-1">
              <div className="w-4 h-4 rounded bg-yellow-500"></div>
              <span className="text-gray-400">0.70-0.85</span>
            </div>
            <div className="flex items-center gap-1">
              <div className="w-4 h-4 rounded bg-orange-500"></div>
              <span className="text-gray-400">0.85-0.95</span>
            </div>
            <div className="flex items-center gap-1">
              <div className="w-4 h-4 rounded bg-red-600"></div>
              <span className="text-gray-400">&gt;0.95 (critical)</span>
            </div>
          </div>
        </div>
      );
    }

    // Section 3: Results Comparison
    function ResultsSection() {
      const resultsData = [
        { metric: 'Perplexity', baseline: 71.05, fim_guided: 63.08, unit: 'PPL', better: 'lower' },
        { metric: 'HellaSwag', baseline: 30, fim_guided: 31, unit: '%', better: 'higher' },
        { metric: 'Compression', baseline: 6, fim_guided: 7.2, unit: 'x', better: 'higher' },
        { metric: 'Global Trace', baseline: 0.818, fim_guided: 0.911, unit: '', better: 'info' },
      ];

      return (
        <div className="card rounded-xl p-6 mb-8">
          <h2 className="text-2xl font-bold mb-2 text-orange-400">Section 3: Results</h2>
          <p className="text-gray-400 mb-4">
            FIM-guided KVSplice achieves 20% extra compression on top of MLA (7.2x vs 6x total)
            while improving quality metrics. Real data from B200x4 1-hour training runs.
          </p>

          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <h3 className="text-lg font-semibold mb-3 text-gray-300">Quality Comparison</h3>
              <ResponsiveContainer width="100%" height={250}>
                <BarChart data={resultsData.slice(0, 2)}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                  <XAxis dataKey="metric" stroke="#9ca3af" />
                  <YAxis stroke="#9ca3af" />
                  <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155' }} />
                  <Legend />
                  <Bar dataKey="baseline" name="MLA Baseline" fill="#3b82f6" />
                  <Bar dataKey="fim_guided" name="KVSplice + FIM" fill="#f97316" />
                </BarChart>
              </ResponsiveContainer>
            </div>

            <div>
              <h3 className="text-lg font-semibold mb-3 text-gray-300">Summary</h3>
              <div className="space-y-3">
                {resultsData.map((r, idx) => {
                  const improvement = r.better === 'lower'
                    ? ((r.baseline - r.fim_guided) / r.baseline * 100).toFixed(1)
                    : r.better === 'higher'
                    ? ((r.fim_guided - r.baseline) / r.baseline * 100).toFixed(1)
                    : null;

                  return (
                    <div key={idx} className="bg-gray-900 rounded-lg p-3">
                      <div className="flex justify-between items-center">
                        <span className="font-semibold text-gray-200">{r.metric}</span>
                        <div className="flex items-center gap-4">
                          <span className="text-blue-400">{r.baseline}{r.unit}</span>
                          <span className="text-gray-500">→</span>
                          <span className="text-orange-400">{r.fim_guided}{r.unit}</span>
                          {improvement && (
                            <span className={`text-xs px-2 py-1 rounded ${
                              parseFloat(improvement) > 0 ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'
                            }`}>
                              {parseFloat(improvement) > 0 ? '+' : ''}{improvement}%
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              <div className="mt-4 bg-orange-900/30 border border-orange-700 rounded-lg p-3">
                <div className="text-orange-400 font-semibold mb-1">Key Result</div>
                <div className="text-sm text-gray-300">
                  FIM-guided compression achieves <strong>11% better perplexity</strong> (63.08 vs 71.05)
                  with <strong>20% more compression</strong> (7.2x vs 6x) by identifying and protecting
                  critical layers while aggressively compressing others.
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Section 4: How KVSplice Works
    function HowItWorksSection() {
      const pipelineSteps = [
        { step: 1, title: 'Compute FIM', desc: 'Run forward pass, compute E[g²] per layer/head' },
        { step: 2, title: 'Rank Layers', desc: 'Sort by trace: high trace = critical, low trace = compressible' },
        { step: 3, title: 'Apply Surgical Compression', desc: 'Aggressive compression on low-trace layers, protection on high-trace' },
        { step: 4, title: 'Train with KVSplice', desc: 'Learned projection for additional KV cache compression' },
      ];

      return (
        <div className="card rounded-xl p-6 mb-8">
          <h2 className="text-2xl font-bold mb-2 text-orange-400">Section 4: How KVSplice Works</h2>
          <p className="text-gray-400 mb-4">
            KVSplice combines MLA's latent compression with FIM-guided surgical optimization.
          </p>

          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <h3 className="text-lg font-semibold mb-3 text-gray-300">FIM-Guided Pipeline</h3>
              <div className="space-y-3">
                {pipelineSteps.map((s, idx) => (
                  <div key={idx} className="flex items-start gap-3">
                    <div className="w-8 h-8 rounded-full bg-orange-600 flex items-center justify-center text-white font-bold flex-shrink-0">
                      {s.step}
                    </div>
                    <div>
                      <div className="font-semibold text-gray-200">{s.title}</div>
                      <div className="text-sm text-gray-400">{s.desc}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div>
              <h3 className="text-lg font-semibold mb-3 text-gray-300">Compression Stack</h3>
              <div className="bg-gray-900 rounded-lg p-4 font-mono text-sm">
                <div className="mb-3">
                  <div className="text-gray-400 mb-1">Standard KV Cache:</div>
                  <div className="text-white">K, V ∈ ℝ^(B×T×H×D) → 36 MB/seq</div>
                </div>
                <div className="mb-3 border-t border-gray-700 pt-3">
                  <div className="text-blue-400 mb-1">+ MLA (6x compression):</div>
                  <div className="text-white">K, V → c ∈ ℝ^(B×T×d_latent) → 6 MB/seq</div>
                </div>
                <div className="border-t border-gray-700 pt-3">
                  <div className="text-orange-400 mb-1">+ KVSplice (1.2x extra):</div>
                  <div className="text-white">c → c' ∈ ℝ^(B×T×d_compressed) → 5 MB/seq</div>
                </div>
                <div className="mt-4 pt-3 border-t border-gray-700">
                  <div className="text-green-400">Total: 7.2x compression</div>
                  <div className="text-gray-400 text-xs">36 MB → 5 MB per sequence</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Main App
    function App() {
      return (
        <div className="max-w-6xl mx-auto px-6 py-12">
          <header className="text-center mb-12">
            <h1 className="text-4xl font-bold mb-4">
              <span className="gradient-text">KVSplice</span>
              <span className="text-gray-400 text-2xl ml-3">FIM-Guided KV Cache Compression</span>
            </h1>
            <p className="text-gray-400 max-w-2xl mx-auto">
              Interactive visualization of how FIM trace guides surgical compression decisions.
              Real data from W&B runs comparing MLA baseline vs KVSplice + FIM guidance.
            </p>
            <div className="mt-4 flex justify-center gap-4">
              <a href="https://github.com/mcgrof/knlp/blob/main/docs/kvsplice/README.md"
                 className="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm font-medium transition-colors">
                Documentation
              </a>
            </div>
          </header>

          <KeyDiscoverySection />
          <LayerTraceSection />
          <HeadHeatmapSection />
          <ResultsSection />
          <HowItWorksSection />

          <footer className="text-center text-gray-600 text-sm border-t border-gray-800 pt-8 mt-12">
            <p>
              Part of <a href="index.html" className="text-blue-400 hover:underline">knlp</a> · MIT License
            </p>
          </footer>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
